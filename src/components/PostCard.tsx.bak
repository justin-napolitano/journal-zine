// src/components/PostCard.tsx
"use client";

import React, { useMemo } from "react";
import type { Post } from "@/lib/db";

type Props = {
  post: Post;
};

function formatDate(iso: string) {
  const d = new Date(iso);
  return d.toLocaleString(undefined, {
    month: "short",
    day: "numeric",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

function linkifyHashtags(text: string): React.ReactNode[] {
  const parts = text.split(/(#[a-zA-Z0-9_]+)/g);
  return parts.map((part, idx) => {
    if (part.startsWith("#")) {
      return (
        <a
          key={idx}
          href={`/?tag=${encodeURIComponent(part.slice(1))}`}
          className="hashtag"
        >
          {part}
        </a>
      );
    }
    return part;
  });
}

export function PostCard({ post }: Props) {
  const content = useMemo(() => linkifyHashtags(post.body), [post.body]);
  const isPhoto = Boolean(post.image_data);

  return (
    <article className="post-card">
      {/* Fixed media box – same for photo + text */}
      <div className="post-media">
        {isPhoto ? (
          // eslint-disable-next-line @next/next/no-img-element
          <img src={post.image_data!} alt="" className="post-image" />
        ) : (
          <div className="post-media-text">
            <div className="post-body">{content}</div>
          </div>
        )}
      </div>

      {/* Fixed caption row – present for all posts */}
      <div className="post-caption">{isPhoto ? content : null}</div>

      <div className="post-meta">
        {formatDate(post.created_at)} · {isPhoto ? "photo" : "note"}
      </div>
    </article>
  );
}

